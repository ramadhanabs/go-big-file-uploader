<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploader</title>

    <link rel="stylesheet" href="main.css">
</head>
<body>
    <div class="container">
        <div class="content-box">
            <div class="input-box">
                <input type="file" id="input" accept="image/*,.pdf" >
                <button id="upload-button">Upload!</button>
            </div>

            <div class="progress-box">
                <div class="progress-bar-container">
                    <div id="progress-bar" style="width: 0%"></div>
                </div>
                <div id="percentage">0%</div>
            </div>
        
            <div class="counter-container">
                <div id="file-size">File size: 0</div>
                <div id="chunk-count">Chunk count: 0</div>
                <div id="file-uploaded-count">File uploaded count: 0</div>
            </div>

            <div class="resume-pause-container">
                <button id="resume-button" disabled>Resume</button>
                <button id="pause-button" disabled>Pause</button>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    function generateUUID() { // Public Domain/MIT
        var d = new Date().getTime();//Timestamp
        var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now()*1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16;//random number between 0 and 16
            if(d > 0){//Use timestamp until depleted
                r = (d + r)%16 | 0;
                d = Math.floor(d/16);
            } else {//Use microseconds since page-load if supported
                r = (d2 + r)%16 | 0;
                d2 = Math.floor(d2/16);
            }
            return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
    }
</script>
<script type="text/javascript">
    // contoller
    let controller, signal;

    // file state
    const chunkSize = 512 * 1000;
    let selectedFile = null;
    let fileSize, fileName, fullChunks, remainedChunk;
    let uploadCount = 0;
    let isUploading = false;

    // event listener
    const progressBarElement = document.getElementById("progress-bar");
    const percentageElement = document.getElementById("percentage");

    const inputElement = document.getElementById("input");
    inputElement.addEventListener("change", handleFiles, false);

    const buttonElement = document.getElementById("upload-button");
    buttonElement.addEventListener("click", handleClickUpload)

    const resumeButtonElement = document.getElementById("resume-button");
    resumeButtonElement.addEventListener("click", handleClickUpload);

    const pauseButtonElement = document.getElementById("pause-button");
    pauseButtonElement.addEventListener("click", handleClickPause)

    function handleFiles() {
        const fileList = this.files;
        selectedFile = fileList[0];

        const fileSize = selectedFile.size;
        const fullChunks = Math.floor(fileSize / chunkSize);
        const remainedChunk = fileSize % chunkSize;

        const fileSizeElement = document.getElementById("file-size");
        fileSizeElement.innerHTML = `File size: ${fileSize}`

        const chunkCountElement = document.getElementById("chunk-count");
        fileSizeElement.innerHTML = `Chunk count: ${fullChunks}`
    }   

    async function handleClickUpload(){
        controller = new AbortController();
        signal = controller.signal;

        const uploadURL = "http://localhost:8080/upload";
        const uploadChunkURL = "http://localhost:8080/chunk-upload";
        
        try {
            isUploading = true;
            resumeButtonElement.setAttribute("disabled", true);
            pauseButtonElement.removeAttribute("disabled");

            let fileId = ""

            if (localStorage.getItem("FILE_ID")){
                fileId = localStorage.getItem("FILE_ID")
            } else {
                fileId = generateUUID();
            }

            fileSize = selectedFile.size;
            fileName = selectedFile.name;
            fullChunks = Math.floor(fileSize / chunkSize);
            remainedChunk = fileSize % chunkSize;

            localStorage.setItem("FILE_ID", fileId)

            if (fullChunks > 0){
               while(uploadCount < fullChunks && isUploading){
                    const data = new FormData();
                    const offset = chunkSize * uploadCount;
                    const limit = chunkSize * (uploadCount + 1);
                    const metadata = {
                        order: uploadCount,
                        fileId,
                        offset,
                        limit,
                        fileSize,
                        fileName
                    }
    
                    const chunkedFile = selectedFile.slice(offset, limit);
    
                    data.append('file', chunkedFile);
                    data.append('metadata', JSON.stringify(metadata))
                    
                    const response = await fetch(uploadChunkURL, {
                        method: "POST",
                        body: data,
                        signal
                    });
        
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }
        
                    const json = await response.json();
                    const fileUploadedCount = document.getElementById("file-uploaded-count");
                    
                    uploadCount++;
                    fileUploadedCount.innerHTML = `File uploaded count: ${uploadCount}`

                    const percentage = uploadCount/fullChunks * 100
                    progressBarElement.style.width = `${percentage}%`
                    percentageElement.innerHTML = `${Math.floor(percentage)}%`

                    console.log(json);
                }

                if (remainedChunk > 0 && isUploading){
                    const data = new FormData();
                    console.log("pushing last item")

                    const offset = fileSize - remainedChunk;
                    const limit = fileSize;
                    const metadata = {
                        order: fullChunks,
                        fileId,
                        offset,
                        limit,
                        fileSize,
                        fileName
                    }

                    const chunkedFile = selectedFile.slice(offset, limit);
                    console.log("ðŸš€ ~ handleClickUpload ~ chunkedFile:", chunkedFile)

                    data.append('file', chunkedFile)
                    data.append('metadata', JSON.stringify(metadata))

                    const response = await fetch(uploadChunkURL, {
                        method: "POST",
                        body: data
                    });
        
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }
        
                    const json = await response.json();
                    console.log(json);
                }
            } else {
                // direct upload
                const data = new FormData();
                data.append('file', selectedFile);
    
                const response = await fetch(uploadURL, {
                    method: "POST",
                    body: data
                });
    
                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }
    
                const json = await response.json();
                console.log(json);
            }
        } catch(error){
            console.log("ðŸš€ ~ handleClickUpload ~ error:", error)
        }
    }

    function handleClickPause(){
        isUploading = false;
        pauseButtonElement.setAttribute("disabled", true);
        resumeButtonElement.removeAttribute("disabled");
        controller.abort();
    }
</script>
</html>